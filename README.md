# ğŸš€ Claude è‡ªä¸»å·¥ç¨‹ç³»ç»Ÿ v2.0 - å¢å¼ºç‰ˆä¸Šä¸‹æ–‡ç®¡ç†

## é—®é¢˜åˆ†æ

ä½ çš„åŸå§‹æ–¹æ¡ˆå·²ç»æŠ“ä½äº†æ ¸å¿ƒé—®é¢˜ï¼š**ä¸Šä¸‹æ–‡å‹ç¼©å¯¼è‡´"è®°å¿†ä¸¢å¤±"**ã€‚ä½†åŸå§‹çš„ `inject_state.py` æ³¨å…¥çš„ä¿¡æ¯å¤ªå°‘ï¼š

```python
# åŸç‰ˆåªæ³¨å…¥è¿™äº›ï¼š
context += f"Current State: {f.read()}\n"  # memory.json å…¨æ–‡
context += line  # ROADMAP.md æœªå®Œæˆä»»åŠ¡
```

è¿™å¯¼è‡´ Claude åœ¨é•¿æ—¶é—´è¿è¡Œåä¸¢å¤±ï¼š
1. ä»£ç åº“çš„æ•´ä½“ç»“æ„
2. å·²å®ç°å‡½æ•°çš„ç­¾å
3. é”™è¯¯å†å²å’Œå°è¯•è¿‡çš„è§£å†³æ–¹æ¡ˆ
4. API å¥‘çº¦ç»†èŠ‚
5. æœ€è¿‘çš„æ–‡ä»¶å˜æ›´

---

## æ”¹è¿›æ–¹æ¡ˆï¼šå¤šå±‚ä¸Šä¸‹æ–‡æ³¨å…¥ç³»ç»Ÿ

### æ ¸å¿ƒæ€æƒ³
**ä¸æ€•æµªè´¹ tokenï¼Œæ€•çš„æ˜¯ä¿¡æ¯ä¸å¤Ÿ**ã€‚æˆ‘ä»¬é‡‡ç”¨åˆ†å±‚æ³¨å…¥ç­–ç•¥ï¼š

```
Layer 0: ç³»ç»ŸæŒ‡ä»¤ (æœ€é«˜ä¼˜å…ˆçº§ - å¿…é¡»å­˜åœ¨)
Layer 1: å½“å‰çŠ¶æ€ (memory.json)
Layer 2: å¾…å¤„ç†ä»»åŠ¡ (ROADMAP.md)
Layer 3: é”™è¯¯å†å² (é˜²æ­¢é‡å¤é”™è¯¯)
Layer 4: API å¥‘çº¦ (æ¥å£è§„èŒƒ)
Layer 5: æ´»è·ƒæ–‡ä»¶å†…å®¹ (æ­£åœ¨ç¼–è¾‘çš„ä»£ç )
Layer 6: é¡¹ç›®ç»“æ„ (ç›®å½•æ ‘ + ç­¾å)
Layer 7: Git å˜æ›´å†å²
Layer 8: æœ€è¿‘å†³ç­–æ—¥å¿—
```

### æ–°å¢æ–‡ä»¶è¯´æ˜

```
.claude/
â”œâ”€â”€ CLAUDE.md                     # ğŸ†• å¢å¼ºç‰ˆåè®® (v2.0)
â”œâ”€â”€ settings.json                 # ğŸ†• æ›´æ–°çš„ hook é…ç½®
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ inject_state_v2.py        # ğŸ†• å¤šå±‚ä¸Šä¸‹æ–‡æ³¨å…¥
â”‚   â”œâ”€â”€ loop_driver_v2.py         # ğŸ†• æ™ºèƒ½å¾ªç¯é©±åŠ¨ (å«æ­»å¾ªç¯æ£€æµ‹)
â”‚   â”œâ”€â”€ error_tracker.py          # ğŸ†• é”™è¯¯å†å²ç®¡ç†
â”‚   â”œâ”€â”€ code_digest.py            # ğŸ†• ä»£ç åº“æ‘˜è¦ç”Ÿæˆå™¨
â”‚   â”œâ”€â”€ pre_write_check.py        # ğŸ†• å†™å…¥å‰æ£€æŸ¥
â”‚   â””â”€â”€ post_write_update.py      # ğŸ†• å†™å…¥åçŠ¶æ€æ›´æ–°
â””â”€â”€ status/
    â”œâ”€â”€ memory.json.template      # ğŸ†• å¢å¼ºç‰ˆçŠ¶æ€æ¨¡æ¿
    â”œâ”€â”€ error_history.json        # ğŸ†• é”™è¯¯å†å²
    â”œâ”€â”€ code_digest.json          # ğŸ†• ä»£ç åº“æ‘˜è¦
    â””â”€â”€ recent_changes.json       # ğŸ†• æœ€è¿‘å˜æ›´è®°å½•
```

---

## å…³é”®æ”¹è¿›è¯¦è§£

### 1. å¤šå±‚ä¸Šä¸‹æ–‡æ³¨å…¥ (`inject_state_v2.py`)

**æ”¹è¿›å‰**ï¼šåªæ³¨å…¥ memory.json å’Œæœªå®Œæˆä»»åŠ¡ï¼ˆ~500 å­—ç¬¦ï¼‰

**æ”¹è¿›å**ï¼šæ³¨å…¥å¤šè¾¾ 50,000 å­—ç¬¦çš„åˆ†å±‚ä¸Šä¸‹æ–‡

```python
# æŒ‰ä¼˜å…ˆçº§æ³¨å…¥ä¸åŒç±»å‹çš„ä¿¡æ¯
context_parts.append(generate_memory_state())        # å½“å‰çŠ¶æ€
context_parts.append(generate_pending_tasks())       # å¾…å¤„ç†ä»»åŠ¡
context_parts.append(generate_error_context())       # é”™è¯¯å†å²
context_parts.append(generate_contract_summary())    # API å¥‘çº¦
context_parts.append(generate_active_files_context()) # æ´»è·ƒæ–‡ä»¶å†…å®¹
context_parts.append(get_project_structure())        # é¡¹ç›®ç»“æ„
```

### 2. é”™è¯¯å†å²ç³»ç»Ÿ (`error_tracker.py`)

é˜²æ­¢ Claude åå¤å°è¯•å·²ç»å¤±è´¥çš„æ–¹æ¡ˆï¼š

```bash
# è®°å½•é”™è¯¯
python3 error_tracker.py add "TASK-001" "ImportError: bcrypt" "å°è¯• pip install"

# æ ‡è®°è§£å†³
python3 error_tracker.py resolve "TASK-001" "å®‰è£…äº†æ­£ç¡®ç‰ˆæœ¬çš„ä¾èµ–"

# æŸ¥çœ‹å†å²
python3 error_tracker.py list
```

åœ¨æ¯æ¬¡ä»»åŠ¡å¼€å§‹æ—¶ï¼Œ`inject_state_v2.py` ä¼šè‡ªåŠ¨æ³¨å…¥ç›¸å…³é”™è¯¯å†å²ã€‚

### 3. ä»£ç åº“æ‘˜è¦ (`code_digest.py`)

é¢„å…ˆæ‰«æä»£ç åº“ï¼Œæå–æ‰€æœ‰å‡½æ•°/ç±»ç­¾åï¼š

```bash
python3 code_digest.py generate .
```

ç”Ÿæˆçš„æ‘˜è¦å¯ä»¥å¸®åŠ© Claude å¿«é€Ÿç†è§£ä»£ç ç»“æ„ï¼Œå³ä½¿åœ¨ä¸Šä¸‹æ–‡å‹ç¼©åä¹Ÿèƒ½"è®°ä½"ä»£ç åº“çš„æ•´ä½“æ¶æ„ã€‚

### 4. æ™ºèƒ½å¾ªç¯é©±åŠ¨ (`loop_driver_v2.py`)

**æ”¹è¿›å‰**ï¼šåªæ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆä»»åŠ¡

**æ”¹è¿›å**ï¼š
- æ£€æµ‹æ­»å¾ªç¯ï¼ˆåŒä¸€ä»»åŠ¡å¤±è´¥ N æ¬¡ï¼‰
- æ£€æµ‹è¿ç»­é”™è¯¯è¿‡å¤š
- æä¾›å…·ä½“çš„æ¢å¤å»ºè®®
- æ”¯æŒç´§æ€¥ç†”æ–­

### 5. å†™å…¥é’©å­ (`pre_write_check.py` + `post_write_update.py`)

- **å†™å…¥å‰**ï¼šæ£€æŸ¥æ˜¯å¦è¿åå¥‘çº¦ï¼Œæ›´æ–°æ´»è·ƒæ–‡ä»¶åˆ—è¡¨
- **å†™å…¥å**ï¼šè®°å½•å˜æ›´å†å²ï¼Œæ›´æ–°æ£€æŸ¥ç‚¹

### 6. å¢å¼ºç‰ˆ memory.json

```json
{
  "session": { ... },           // ä¼šè¯çº§ä¿¡æ¯
  "current_task": { ... },      // å½“å‰ä»»åŠ¡è¯¦æƒ…
  "active_files": [...],        // æ´»è·ƒæ–‡ä»¶åˆ—è¡¨ï¼ˆæ–°å¢ï¼‰
  "working_context": {          // å·¥ä½œä¸Šä¸‹æ–‡ï¼ˆæ–°å¢ï¼‰
    "current_file": "...",
    "current_function": "...",
    "pending_tests": [...],
    "pending_implementations": [...]
  },
  "error_state": { ... },       // é”™è¯¯çŠ¶æ€
  "checkpoints": [...],         // æ£€æŸ¥ç‚¹å†å²ï¼ˆæ–°å¢ï¼‰
  "decisions_made": [...],      // å†³ç­–å†å²ï¼ˆæ–°å¢ï¼‰
  "next_action": { ... }        // ä¸‹ä¸€æ­¥è¡ŒåŠ¨
}
```

---

## ä½¿ç”¨æŒ‡å—

### åˆå§‹åŒ–é¡¹ç›®

```bash
# 1. åˆ›å»ºçŠ¶æ€ç›®å½•
mkdir -p .claude/status

# 2. åˆå§‹åŒ– memory.json
cp .claude/status/memory.json.template .claude/status/memory.json

# 3. ç”Ÿæˆä»£ç æ‘˜è¦
python3 .claude/hooks/code_digest.py generate .

# 4. åˆ›å»º ROADMAP.md
# (ä½¿ç”¨ project-architect-supervisor agent)
```

### è¿è¡Œå¾ªç¯

```bash
# å¯åŠ¨ Claude Codeï¼Œå®ƒä¼šè‡ªåŠ¨ï¼š
# 1. æ¯æ¬¡äº¤äº’æ³¨å…¥å®Œæ•´ä¸Šä¸‹æ–‡
# 2. å†™å…¥æ–‡ä»¶æ—¶è‡ªåŠ¨è¿½è¸ª
# 3. å°è¯•åœæ­¢æ—¶æ£€æŸ¥ä»»åŠ¡å®Œæˆåº¦
```

---

## Token ä½¿ç”¨ä¼°ç®—

| ç»„ä»¶ | ä¼°ç®— Token æ•° |
|------|-------------|
| ç³»ç»ŸæŒ‡ä»¤ | ~200 |
| memory.json | ~500 |
| å¾…å¤„ç†ä»»åŠ¡ | ~500 |
| é”™è¯¯å†å² | ~1,000 |
| API å¥‘çº¦ | ~2,000 |
| æ´»è·ƒæ–‡ä»¶ï¼ˆ5ä¸ªï¼‰| ~5,000 |
| é¡¹ç›®ç»“æ„ | ~2,000 |
| Git å†å² | ~500 |
| **æ€»è®¡** | **~12,000** |

åœ¨ 200K ä¸Šä¸‹æ–‡çª—å£ä¸­ï¼Œè¿™åªå  6%ï¼Œå®Œå…¨å¯ä»¥æ¥å—ã€‚

---

## è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### 1. æ·»åŠ å‘é‡æ£€ç´¢ï¼ˆé«˜çº§ï¼‰
å¦‚æœä»£ç åº“å¾ˆå¤§ï¼Œå¯ä»¥é›†æˆå‘é‡æ•°æ®åº“ï¼š
- æ¯ä¸ªå‡½æ•°ç”Ÿæˆ embedding
- æ ¹æ®å½“å‰ä»»åŠ¡æ£€ç´¢æœ€ç›¸å…³çš„ä»£ç ç‰‡æ®µ

### 2. æ·»åŠ  AST åˆ†æ
æ›´ç²¾ç¡®åœ°æå–ä»£ç ç»“æ„ï¼š
```python
import ast
tree = ast.parse(code)
# æå–ç±»ã€å‡½æ•°ã€ä¾èµ–å…³ç³»
```

### 3. æ·»åŠ  Test Coverage è¿½è¸ª
çŸ¥é“å“ªäº›ä»£ç å·²ç»è¢«æµ‹è¯•è¦†ç›–ï¼Œå“ªäº›è¿˜æ²¡æœ‰ã€‚

### 4. æ·»åŠ  Dependency Graph
è¿½è¸ªæ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œé¿å…å¾ªç¯ä¾èµ–å’Œä¸ä¸€è‡´çš„ä¿®æ”¹ã€‚

---

## å¸¸è§é—®é¢˜

**Q: æ³¨å…¥è¿™ä¹ˆå¤šå†…å®¹ä¼šä¸ä¼šå¤ªæ…¢ï¼Ÿ**
A: `inject_state_v2.py` æ‰§è¡Œæ—¶é—´é€šå¸¸ < 100msï¼Œå¯¹ç”¨æˆ·ä½“éªŒå½±å“æå°ã€‚

**Q: å¦‚ä½•çŸ¥é“ä¸Šä¸‹æ–‡æ³¨å…¥æ˜¯å¦å·¥ä½œï¼Ÿ**
A: æ£€æŸ¥ Claude çš„å“åº”æ˜¯å¦å¼•ç”¨äº†æ³¨å…¥çš„ä¿¡æ¯ï¼Œå¦‚ "Based on memory.json, the current task is..."

**Q: å¦‚ä½•è°ƒæ•´æ³¨å…¥çš„ä¿¡æ¯é‡ï¼Ÿ**
A: ä¿®æ”¹ `inject_state_v2.py` ä¸­çš„ `CONTEXT_BUDGET` å˜é‡ã€‚

---

## æ€»ç»“

ä½ çš„åŸå§‹æ–¹æ¡ˆæ–¹å‘æ˜¯å¯¹çš„ï¼Œä½†éœ€è¦æ›´"æ¿€è¿›"åœ°æ³¨å…¥ä¸Šä¸‹æ–‡ã€‚æ ¸å¿ƒæ”¹è¿›ï¼š

1. **æ›´å¤šä¿¡æ¯**ï¼šä» ~500 å­—ç¬¦æå‡åˆ° ~12,000 token
2. **æ›´ç»“æ„åŒ–**ï¼šåˆ†å±‚æ³¨å…¥ï¼Œä¼˜å…ˆçº§æ˜ç¡®
3. **æ›´æ™ºèƒ½**ï¼šè‡ªåŠ¨è¿½è¸ªé”™è¯¯å†å²ã€æ´»è·ƒæ–‡ä»¶ã€ä»£ç ç»“æ„
4. **æ›´å¥å£®**ï¼šæ­»å¾ªç¯æ£€æµ‹ã€ç´§æ€¥ç†”æ–­

è®°ä½ï¼š**ä¸æ€•æµªè´¹ tokenï¼Œæ€•çš„æ˜¯ä¿¡æ¯ä¸å¤Ÿ**ã€‚åœ¨ 200K ä¸Šä¸‹æ–‡çª—å£æ—¶ä»£ï¼Œæˆ‘ä»¬æœ‰å……è¶³çš„ç©ºé—´æ¥ä¿è¯ Claude çš„"è®°å¿†"æŒä¹…å¯é ã€‚
